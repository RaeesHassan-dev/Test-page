const rawUser = JSON.parse(localStorage.getItem("user") || "{}");

function fullyDecode(value) {
  let decoded = value ?? "";
  let prev;
  try {
    do {
      prev = decoded;
      decoded = decodeURIComponent(decoded);
    } while (decoded !== prev);
  } catch (e) {}
  return decoded;
}

const user = {
  name: fullyDecode(rawUser.name),
  email: fullyDecode(rawUser.email),
  oid: fullyDecode(rawUser.oid),
  planType: fullyDecode(rawUser.planType),
  accountID: fullyDecode(rawUser.accountID),
  accountStatus: fullyDecode(rawUser.accountStatus)
};

const wfVars = [
  `custname=${user.name}`,
  `custemail=${user.email}`,
  `custphone=${user.oid}`,
  `planType=${user.planType}`,
  `accountID=${user.accountID}`,
  `accountStatus=${user.accountStatus}`
].join(",");

const fab = document.createElement("img");
fab.id = "dx_chatbot_fab_id";
fab.src = "https://us-central.dx.dialpad.com/kpd-static/providers/83087440/webchat/bda2a68bb340432b98fcf502a734dec2/images/fab-icon.png";
fab.style = "clip-path:circle(50%); object-fit: contain; height: auto; width: 100%;";
fab.setAttribute("data-dxchannelid", "bda2a68bb340432b98fcf502a734dec2");
fab.setAttribute("data-dxprovemail", "5495351674880000@hrforhealth.com");
fab.setAttribute("data-dxwfvars", wfVars);

const wrapper = document.createElement("div");
wrapper.id = "dx_chatbot_fab_wrapper_id";
wrapper.style = `
  background-color:#6c1396;
  border-radius:50%;
  box-sizing: border-box;
  display: flex;
  height:56px;
  overflow:hidden;
  padding:12px;
  width:56px;
  position: fixed;
  bottom: 16px;
  right: 16px;
  z-index: 123;
`;
wrapper.appendChild(fab);
document.body.appendChild(wrapper);
